<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>スマホ専用カメラ＋円トリミング＋送信</title>
<style>
body { text-align: center; margin: 0; background: #fff; font-family: sans-serif; }
#camera-container { position: relative; display: inline-block; width: 100vw; max-width: 100%; aspect-ratio: 16/9; background: black; }
video, canvas, #no-signal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
video { object-fit: cover; }
#overlay { pointer-events: none; }
#no-signal { display: none; align-items: center; justify-content: center; background: rgba(255,255,255,0.7); color: black; font-size: 1.2em; }
button { margin-top: 10px; padding: 6px 12px; font-size: 1em; border-radius: 5px; border: none; cursor: pointer; }
#af-status { margin-top: 8px; font-size: 0.9em; color: #555; }
#preview-dialog, #complete-dialog { display: none; position: fixed; top:0; left:0; width:100%; height:100%; align-items: center; justify-content: center; z-index: 9999; background: rgba(0,0,0,0.5);}
#preview-box, #complete-dialog > div { background: #fff; padding: 15px; border-radius: 10px; text-align: center; max-width: 90%; }
#preview-canvas { border:1px solid #ccc; background:#eee; width:300px; height:300px; touch-action: none; cursor: grab; }
.preview-btn { margin: 5px; padding: 6px 12px; font-size: 1em; border: none; border-radius: 5px; cursor: pointer; }
.save-btn { background: #4CAF50; color: white; }
.cancel-btn { background: #f44336; color: white; }
#complete-btn { padding: 8px 20px; font-size: 1.1em; border: none; border-radius: 5px; background: #4CAF50; color: #fff; cursor: pointer; }
#saved-images { margin-top: 15px; display: flex; justify-content: center; }
#saved-images img { max-width: 150px; border: 1px solid #ccc; border-radius: 4px; }
#analysis-result { margin-top: 10px; font-size: 0.95em; color: #333; }
#upload-input { margin-top:10px; }
</style>
</head>
<body>

<div id="camera-container">
  <video id="video" autoplay playsinline></video>
  <canvas id="overlay"></canvas>
  <div id="no-signal">No signal</div>
</div><br>

<!-- スマホ判定で表示 -->
<button id="control-btn" onclick="toggleCamera()">カメラ開始</button>
<button id="capture-btn" onclick="captureImage()">カメラ画像取得</button>
<br>
<input type="file" id="upload-input" accept="image/*">

<div id="af-status">AF状態: 未確認</div>

<div id="preview-dialog">
  <div id="preview-box">
    <canvas id="preview-canvas" width="300" height="300"></canvas>
    <div>
      <button class="preview-btn save-btn" onclick="confirmSave()">円内を保存</button>
      <button class="preview-btn cancel-btn" onclick="closePreview()">キャンセル</button>
    </div>
    <p>赤い円内が切り取られる範囲です。ドラッグで位置調整、ピンチでズーム可能。</p>
  </div>
</div>

<div id="complete-dialog">
  <div>
    <p>画像の保存が完了しました。</p>
    <button id="complete-btn">完了</button>
  </div>
</div>

<h3>最新画像</h3>
<div id="saved-images"></div>
<h3>解析結果</h3>
<div id="analysis-result"></div>

<script>
const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
if(!isMobile){
  document.getElementById("control-btn").style.display="none";
  document.getElementById("capture-btn").style.display="none";
  document.getElementById("upload-input").style.display="none";
  document.getElementById("af-status").textContent="スマホのみ使用可能です";
}

// --- 要素 ---
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const noSignal = document.getElementById('no-signal');
const afStatus = document.getElementById('af-status');
const controlBtn = document.getElementById('control-btn');
const captureBtn = document.getElementById('capture-btn');

const previewDialog = document.getElementById('preview-dialog');
const previewCanvas = document.getElementById('preview-canvas');
const previewCtx = previewCanvas.getContext('2d');

const savedImages = document.getElementById('saved-images');
const analysisResult = document.getElementById('analysis-result');
const uploadInput = document.getElementById('upload-input');

let isPaused=false, isStarted=false, savedStream=null, currentImageData=null;
let originalImage = new Image();

// 画像移動・ズーム
let imgX=0, imgY=0, startX=0, startY=0, isDragging=false;
let scale=1;

// 円固定
const circleX=previewCanvas.width/2;
const circleY=previewCanvas.height/2;
const circleR=Math.min(previewCanvas.width, previewCanvas.height)/2-5;

// --- カメラ ---
function resizeOverlay(){ overlay.width=overlay.offsetWidth; overlay.height=overlay.offsetHeight; }
function drawCenterCircle(){ ctx.clearRect(0,0,overlay.width,overlay.height); const cx=overlay.width/2, cy=overlay.height/2, r=Math.min(overlay.width,overlay.height)/4; ctx.beginPath(); ctx.arc(cx, cy, r,0,Math.PI*2); ctx.lineWidth=3; ctx.strokeStyle="black"; ctx.stroke(); }

async function startCamera(){
  if(!isMobile) return;
  try{
    const constraints={video:{facingMode:{ideal:"environment"}},audio:false};
    const stream=await navigator.mediaDevices.getUserMedia(constraints);
    savedStream=stream; video.srcObject=stream; video.play(); isPaused=false; isStarted=true;
    noSignal.style.display="none"; controlBtn.textContent="静止";
    resizeOverlay(); drawCenterCircle();
  }catch(err){ noSignal.style.display="flex"; video.srcObject=null; afStatus.textContent="AF状態: 起動失敗"; alert('カメラ起動失敗: '+err.message); }
}
function toggleCamera(){ if(!isStarted) startCamera(); else if(!isPaused){ video.pause(); isPaused=true; controlBtn.textContent="再開"; } else { video.play(); isPaused=false; controlBtn.textContent="静止"; } }

function captureImage(){
  if(!isStarted){ alert("カメラを開始してください"); return; }
  const tempCanvas=document.createElement("canvas");
  tempCanvas.width=video.videoWidth;
  tempCanvas.height=video.videoHeight;
  tempCanvas.getContext("2d").drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
  loadPreview(tempCanvas.toDataURL("image/png"));
}

// アップロード
uploadInput.onchange = e => { if(!e.target.files[0]) return; const reader=new FileReader(); reader.onload=ev => loadPreview(ev.target.result); reader.readAsDataURL(e.target.files[0]); };

// --- プレビュー ---
function loadPreview(dataURL){
  originalImage.src=dataURL;
  originalImage.onload=()=>{
    scale=1; imgX=0; imgY=0; clampScale(); clampPosition(); drawPreview();
    previewDialog.style.display="flex"; currentImageData=dataURL;
  };
}

// --- プレビュー描画 ---
function drawPreview(){
  clampScale(); clampPosition();
  previewCtx.clearRect(0,0,previewCanvas.width,previewCanvas.height);

  // 円外を暗く
  previewCtx.fillStyle='rgba(0,0,0,0.5)'; previewCtx.fillRect(0,0,previewCanvas.width,previewCanvas.height);

  previewCtx.save();
  previewCtx.beginPath(); previewCtx.arc(circleX,circleY,circleR,0,Math.PI*2); previewCtx.closePath(); previewCtx.clip();
  previewCtx.drawImage(originalImage,imgX,imgY,previewCanvas.width*scale,previewCanvas.height*scale);
  previewCtx.restore();

  previewCtx.strokeStyle="red"; previewCtx.lineWidth=2; previewCtx.beginPath(); previewCtx.arc(circleX,circleY,circleR,0,Math.PI*2); previewCtx.stroke();
}

// --- 制限 ---
function clampScale(){ const minScale=Math.max((circleR*2)/previewCanvas.width,(circleR*2)/previewCanvas.height); if(scale<minScale) scale=minScale; }
function clampPosition(){ const left=circleX-circleR; const top=circleY-circleR; const right=circleX+circleR; const bottom=circleY+circleR; const scaledW=previewCanvas.width*scale; const scaledH=previewCanvas.height*scale; if(imgX>left) imgX=left; if(imgY>top) imgY=top; if(imgX+scaledW<right) imgX=right-scaledW; if(imgY+scaledH<bottom) imgY=bottom-scaledH; }

// --- ドラッグ ---
previewCanvas.onmousedown=e=>{ isDragging=true; startX=e.clientX; startY=e.clientY; };
previewCanvas.onmousemove=e=>{ if(!isDragging) return; imgX+=e.clientX-startX; imgY+=e.clientY-startY; startX=e.clientX; startY=e.clientY; drawPreview(); };
previewCanvas.onmouseup=e=>{ isDragging=false; };
previewCanvas.onmouseleave=e=>{ isDragging=false; };

// --- ズーム（円中心固定） ---
function zoomAtCenter(delta){
  const prevScale = scale;
  scale*=delta; clampScale();
  imgX=circleX-(circleX-imgX)*(scale/prevScale);
  imgY=circleY-(circleY-imgY)*(scale/prevScale);
  clampPosition(); drawPreview();
}
previewCanvas.onwheel=e=>{ e.preventDefault(); zoomAtCenter(e.deltaY<0?1.1:0.9); };
previewCanvas.ontouchstart=e=>{
  if(e.touches.length===1){ isDragging=true; startX=e.touches[0].clientX; startY=e.touches[0].clientY; }
  else if(e.touches.length===2){ lastDist=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY); isDragging=false; }
};
previewCanvas.ontouchmove=e=>{
  e.preventDefault();
  if(e.touches.length===1 && isDragging){ imgX+=e.touches[0].clientX-startX; imgY+=e.touches[0].clientY-startY; startX=e.touches[0].clientX; startY=e.touches[0].clientY; drawPreview(); }
  else if(e.touches.length===2){
    const dist=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY);
    zoomAtCenter(dist/lastDist); lastDist=dist;
  }
};
previewCanvas.ontouchend=e=>{ if(e.touches.length<2) lastDist=0; if(e.touches.length===0) isDragging=false; };

// --- 閉じる ---
function closePreview(){ previewDialog.style.display="none"; currentImageData=null; }

// --- 保存（円内切り取り＋サーバー送信） ---
function confirmSave(){
  const cropCanvas=document.createElement("canvas");
  cropCanvas.width=circleR*2; cropCanvas.height=circleR*2;
  const ctx2=cropCanvas.getContext("2d");
  ctx2.beginPath(); ctx2.arc(circleR,circleR,circleR,0,Math.PI*2); ctx2.closePath(); ctx2.clip();
  ctx2.drawImage(originalImage,(-imgX+circleX-circleR)/scale,(-imgY+circleY-circleR)/scale,previewCanvas.width/scale,previewCanvas.height/scale,0,0,circleR*2,circleR*2);
  const sendData=cropCanvas.toDataURL("image/png");
  fetch("https://78596d55379b.ngrok-free.app/upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image:sendData, device_id:"device_test"})})
  .then(res=>res.json()).then(data=>{
    previewDialog.style.display="none"; document.getElementById("complete-dialog").style.display="flex";
    const completeBtn=document.getElementById("complete-btn");
    completeBtn.onclick=()=>{ document.getElementById("complete-dialog").style.display="none"; const img=document.createElement("img"); img.src=sendData; savedImages.innerHTML=""; savedImages.appendChild(img); currentImageData=null; };
  }).catch(err=>{ alert("送信失敗:"+err.message); });
}

window.addEventListener("resize",()=>{ if(isStarted){ resizeOverlay(); drawCenterCircle(); } });
</script>
</body>
</html>
