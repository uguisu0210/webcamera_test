<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>カメラ＋アップロード＋プレビュー確認＋ピンク解析</title>
<style>
body { text-align: center; margin: 0; background: #fff; font-family: sans-serif; }
#camera-container { position: relative; display: inline-block; width: 100vw; max-width: 100%; aspect-ratio: 16 / 9; background: black; }
video, canvas, #no-signal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
video { object-fit: cover; }
#overlay { pointer-events: none; }
#no-signal { display: none; align-items: center; justify-content: center; background: rgba(255,255,255,0.7); color: black; font-size: 1.2em; }
button { margin-top: 10px; padding: 6px 12px; font-size: 1em; border-radius: 5px; border: none; cursor: pointer; }
#af-status { margin-top: 8px; font-size: 0.9em; color: #555; }
#preview-dialog, #complete-dialog { display: none; position: fixed; top:0; left:0; width:100%; height:100%; align-items: center; justify-content: center; z-index: 9999; }
#preview-box, #complete-dialog > div { background: #fff; padding: 15px; border-radius: 10px; text-align: center; max-width: 90%; }
#preview-img {
  width: 300px;      /* 固定幅 */
  height: 200px;     /* 固定高さ */
  object-fit: contain; /* 縦横比を保持して収める */
  border: 1px solid #ccc;
  margin-bottom: 10px;
}
.preview-btn { margin: 5px; padding: 6px 12px; font-size: 1em; border: none; border-radius: 5px; cursor: pointer; }
.save-btn { background: #4CAF50; color: white; }
.cancel-btn { background: #f44336; color: white; }
#complete-btn { padding: 8px 20px; font-size: 1.1em; border: none; border-radius: 5px; background: #4CAF50; color: #fff; cursor: pointer; }
#saved-images { margin-top: 15px; display: flex; justify-content: center; }
#saved-images img { max-width: 150px; border: 1px solid #ccc; border-radius: 4px; }
#analysis-result { margin-top: 10px; font-size: 0.95em; color: #333; }
</style>
</head>
<body>

<h2>カメラ撮影／画像アップロード＋プレビュー確認＋ピンク解析</h2>

<div id="camera-container">
  <video id="video" autoplay playsinline></video>
  <canvas id="overlay"></canvas>
  <div id="no-signal">No signal</div>
</div><br>

<button id="control-btn" onclick="toggleCamera()">カメラ開始</button>
<button onclick="captureImage()">カメラ画像保存</button>
<div id="af-status">AF状態: 未確認</div>

<h3>画像アップロード</h3>
<input type="file" id="upload-input" accept="image/*">
<button onclick="previewUploadImage()">アップロード確認</button>

<!-- プレビュー -->
<div id="preview-dialog">
  <div id="preview-box">
    <img id="preview-img" src="">
    <div>
      <button class="preview-btn save-btn" onclick="confirmSave()">保存する</button>
      <button class="preview-btn cancel-btn" onclick="closePreview()">キャンセル</button>
    </div>
  </div>
</div>

<!-- 保存完了 -->
<div id="complete-dialog">
  <div>
    <p>画像の保存が完了しました。</p>
    <button id="complete-btn">完了</button>
  </div>
</div>

<h3>最新画像</h3>
<div id="saved-images"></div>

<h3>解析結果</h3>
<div id="analysis-result"></div>

<script>
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const noSignal = document.getElementById('no-signal');
const afStatus = document.getElementById('af-status');
const controlBtn = document.getElementById('control-btn');
const ctx = overlay.getContext('2d');
const previewDialog = document.getElementById('preview-dialog');
const previewImg = document.getElementById('preview-img');
const savedImages = document.getElementById('saved-images');
const analysisResult = document.getElementById('analysis-result');
let isPaused = false, isStarted = false, savedStream = null, currentImageData = null;

// 端末ID
function getDeviceId() {
  let id = localStorage.getItem("device_id");
  if (!id) { id = "device_" + Math.random().toString(36).slice(2); localStorage.setItem("device_id", id); }
  return id;
}

// カメラ関連
function resizeOverlay() { overlay.width = overlay.offsetWidth; overlay.height = overlay.offsetHeight; }
function drawCenterCircle() { ctx.clearRect(0,0,overlay.width,overlay.height); const cx=overlay.width/2,cy=overlay.height/2,r=Math.min(overlay.width,overlay.height)/4; ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.lineWidth=3; ctx.strokeStyle="black"; ctx.stroke(); }
function pauseCamera() { if(video.srcObject&&!isPaused){video.pause();isPaused=true;afStatus.textContent="AF状態: 一時停止中";controlBtn.textContent="再開";} }
function resumeCamera() { if(savedStream&&isPaused){video.play();isPaused=false;afStatus.textContent="AF状態: 再開中";controlBtn.textContent="静止";} }
async function startCamera() {
  try {
    if(location.protocol!=='https:'&&location.hostname!=='localhost'){alert('カメラはHTTPSまたはlocalhostのみ');return;}
    const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const constraints = { video: isMobile?{facingMode:{ideal:"environment"}}:{width:{ideal:1280},height:{ideal:720}}, audio:false };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    savedStream=stream; video.srcObject=stream; video.play(); isPaused=false; isStarted=true;
    noSignal.style.display="none"; controlBtn.textContent="静止"; resizeOverlay(); drawCenterCircle();
  } catch(err){ noSignal.style.display="flex"; video.srcObject=null; afStatus.textContent="AF状態: 起動失敗"; alert(err.message); }
}
function toggleCamera() { if(!isStarted) startCamera(); else if(!isPaused) pauseCamera(); else resumeCamera(); }

// カメラキャプチャ
function captureImage() {
  if(!isStarted){alert("カメラを開始してください"); return;}
  const tempCanvas=document.createElement("canvas");
  tempCanvas.width=video.videoWidth; tempCanvas.height=video.videoHeight;
  tempCanvas.getContext("2d").drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
  currentImageData=tempCanvas.toDataURL("image/png");
  previewImg.src=currentImageData; previewDialog.style.display="flex";
}

// アップロード画像プレビュー
function previewUploadImage() {
  const fileInput = document.getElementById("upload-input");
  if(!fileInput.files||fileInput.files.length===0){alert("画像を選択してください"); return;}
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = e => { currentImageData=e.target.result; previewImg.src=currentImageData; previewDialog.style.display="flex"; };
  reader.readAsDataURL(file);
}

// プレビュー & 保存
function closePreview(){ previewDialog.style.display="none"; currentImageData=null; }

function confirmSave() {
  if(!currentImageData){ alert("保存画像なし"); return; }
  const deviceId = getDeviceId();
  fetch("https://866797d83d83.ngrok-free.app/upload",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({image:currentImageData,device_id:deviceId})
  })
  .then(async res=>{
    if(!res.ok){ const errData=await res.json().catch(()=>({})); throw new Error(`HTTP ${res.status}: ${errData.message||"不明なエラー"}`); }
    return res.json();
  })
  .then(data=>{
    if(data.status==="ok"){
      previewDialog.style.display="none";
      const completeDialog = document.getElementById("complete-dialog");
      completeDialog.style.display="flex";
      const completeBtn = document.getElementById("complete-btn");
      completeBtn.onclick=null;
      completeBtn.onclick=()=>{
        completeDialog.style.display="none";
        savedImages.innerHTML="";
        const img=document.createElement("img"); img.src=currentImageData; savedImages.appendChild(img);
        analysisResult.innerHTML = `
          平均RGB: ${data.pink_avg.avg_rgb}<br>
          HEX: ${data.pink_avg.hex}<br>
          濃淡スコア: ${data.pink_avg.shade_score} (${data.pink_avg.shade_level})<br>
          平均S: ${data.pink_avg.avg_S.toFixed(1)}, 平均V: ${data.pink_avg.avg_V.toFixed(1)}
        `;
        currentImageData=null;
      };
    }else{ throw new Error(data.message||"サーバーがエラーを返しました"); }
  })
  .catch(err=>{ console.error(err); alert(`サーバ送信エラー: ${err.message}`); });
}

window.addEventListener("resize",()=>{ if(isStarted){resizeOverlay(); drawCenterCircle();} });
</script>

</body>
</html>
