<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>固定円トリミング＋円内切り取り＋ズーム＋プレビュー＋ピンク解析</title>
<style>
body { text-align: center; margin: 0; background: #fff; font-family: sans-serif; }
#camera-container { position: relative; display: inline-block; }
#camera { border: 1px solid #ccc; border-radius: 10px; }
#overlay {
  position: absolute;
  top: 0; left: 0;
  border: 2px solid red;
  border-radius: 50%;
  pointer-events: none;
}
button {
  margin: 10px; padding: 10px 20px;
  font-size: 16px; border: none; border-radius: 5px;
  background: #007BFF; color: white; cursor: pointer;
}
button:hover { background: #0056b3; }
#result {
  margin-top: 20px; font-size: 18px;
  font-weight: bold; color: #333;
}
#preview-dialog, #complete-dialog {
  display: none;                /* 初期は非表示 */
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.5);
  z-index: 9999;

  /* flex で縦横中央配置 */
  display: flex;
  align-items: center;
  justify-content: center;
}
#preview-box, #complete-box {
  background: #fff;
  padding: 15px;
  border-radius: 10px;
  text-align: center;
  max-width: 90%;
}
#preview-canvas {
  max-width: 100%;
  border: 1px solid #ccc;
  border-radius: 10px;
}
#zoom-controls {
  margin-top: 10px;
}
#zoom-controls button {
  margin: 5px;
}
</style>
</head>
<body>

<h2>固定円トリミング＋ピンク解析</h2>

<div id="camera-container">
  <video id="camera" autoplay playsinline></video>
  <div id="overlay"></div>
</div><br>

<button id="start-camera">カメラ開始</button>
<button id="capture">撮影</button>
<input type="file" id="upload" accept="image/*">
<div id="result"></div>

<!-- トリミングプレビュー -->
<div id="preview-dialog">
  <div id="preview-box">
    <h3>トリミングプレビュー</h3>
    <canvas id="preview-canvas"></canvas>
    <div id="zoom-controls">
      <button id="zoom-in">＋</button>
      <button id="zoom-out">－</button>
      <button id="move-left">←</button>
      <button id="move-right">→</button>
      <button id="move-up">↑</button>
      <button id="move-down">↓</button>
    </div>
    <button id="save">保存</button>
    <button id="cancel">キャンセル</button>
  </div>
</div>

<!-- 保存完了ダイアログ -->
<div id="complete-dialog">
  <div id="complete-box">
    <h3>保存が完了しました</h3>
    <button id="close-complete">閉じる</button>
  </div>
</div>

<script>
const video = document.getElementById('camera');
const overlay = document.getElementById('overlay');
const startCameraBtn = document.getElementById('start-camera');
const captureBtn = document.getElementById('capture');
const uploadInput = document.getElementById('upload');
const resultDiv = document.getElementById('result');
const previewDialog = document.getElementById('preview-dialog');
const previewCanvas = document.getElementById('preview-canvas');
const previewCtx = previewCanvas.getContext('2d');
const saveBtn = document.getElementById('save');
const cancelBtn = document.getElementById('cancel');
const completeDialog = document.getElementById('complete-dialog');
const closeCompleteBtn = document.getElementById('close-complete');

let stream, image, zoom=1, offsetX=0, offsetY=0;

// カメラ開始
startCameraBtn.onclick = async () => {
  stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
  video.onloadedmetadata = () => {
    overlay.style.width = video.videoWidth/2 + "px";
    overlay.style.height = video.videoWidth/2 + "px";
    overlay.style.left = (video.offsetWidth - video.videoWidth/2)/2 + "px";
    overlay.style.top = (video.offsetHeight - video.videoWidth/2)/2 + "px";
  };
};

// 撮影
captureBtn.onclick = () => {
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);
  image = new Image();
  image.onload = () => showPreview();
  image.src = canvas.toDataURL("image/png");
};

// アップロード
uploadInput.onchange = e => {
  const file = e.target.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = ev => {
      image = new Image();
      image.onload = () => showPreview();
      image.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  }
};

// プレビュー表示
function showPreview(){
  zoom = 1; offsetX=0; offsetY=0;
  previewCanvas.width = image.width;
  previewCanvas.height = image.height;
  drawPreview();
  previewDialog.style.display = "block";  // flexはCSSに任せる
}

// プレビュー描画
function drawPreview(){
  previewCtx.clearRect(0,0,previewCanvas.width, previewCanvas.height);
  const iw = image.width * zoom;
  const ih = image.height * zoom;
  const ix = (previewCanvas.width - iw)/2 + offsetX;
  const iy = (previewCanvas.height - ih)/2 + offsetY;
  previewCtx.drawImage(image, ix, iy, iw, ih);
  previewCtx.beginPath();
  const radius = Math.min(previewCanvas.width, previewCanvas.height)/4;
  previewCtx.arc(previewCanvas.width/2, previewCanvas.height/2, radius, 0, Math.PI*2);
  previewCtx.strokeStyle = "red";
  previewCtx.lineWidth = 3;
  previewCtx.stroke();
}

// ズーム・移動
document.getElementById('zoom-in').onclick = ()=>{ zoom*=1.1; drawPreview(); };
document.getElementById('zoom-out').onclick = ()=>{ zoom/=1.1; drawPreview(); };
document.getElementById('move-left').onclick = ()=>{ offsetX-=10; drawPreview(); };
document.getElementById('move-right').onclick = ()=>{ offsetX+=10; drawPreview(); };
document.getElementById('move-up').onclick = ()=>{ offsetY-=10; drawPreview(); };
document.getElementById('move-down').onclick = ()=>{ offsetY+=10; drawPreview(); };

// 保存
saveBtn.onclick = ()=>{
  const radius = Math.min(previewCanvas.width, previewCanvas.height)/4;
  const cx = previewCanvas.width/2, cy = previewCanvas.height/2;
  const cropCanvas = document.createElement('canvas');
  cropCanvas.width = radius*2;
  cropCanvas.height = radius*2;
  const cropCtx = cropCanvas.getContext('2d');
  cropCtx.beginPath();
  cropCtx.arc(radius, radius, radius, 0, Math.PI*2);
  cropCtx.clip();
  cropCtx.drawImage(previewCanvas, cx-radius, cy-radius, radius*2, radius*2, 0, 0, radius*2, radius*2);
  const croppedDataUrl = cropCanvas.toDataURL("image/png");

  // サーバー送信
  fetch("https://df1b78b2faab.ngrok-free.app/upload", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ image: croppedDataUrl })
  })
  .then(r=>r.json()).then(data=>{
    resultDiv.textContent = "解析結果: " + data.result;
    previewDialog.style.display = "none";
    completeDialog.style.display = "block";
  });
};

// キャンセル
cancelBtn.onclick = ()=>{ previewDialog.style.display = "none"; };

// 完了ダイアログ閉じる
closeCompleteBtn.onclick = ()=>{ completeDialog.style.display = "none"; };
</script>

</body>
</html>
