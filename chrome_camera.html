<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>カメラ＋アップロード＋トリミング＋ピンク解析</title>
<style>
  body { text-align: center; margin: 0; background: #fff; font-family: sans-serif; }
  #camera-container { position: relative; display: inline-block; width: 100vw; max-width: 100%; aspect-ratio: 16/9; background: black; }
  video, canvas, #no-signal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
  video { object-fit: cover; }
  #overlay { pointer-events: none; }
  #no-signal { display: none; align-items: center; justify-content: center; background: rgba(255,255,255,0.7); color: black; font-size: 1.2em; }
  button { margin-top: 10px; padding: 6px 12px; font-size: 1em; border-radius: 5px; border: none; cursor: pointer; }
  #af-status { margin-top: 8px; font-size: 0.9em; color: #555; }
  #preview-dialog, #complete-dialog { display: none; position: fixed; top:0; left:0; width:100%; height:100%; align-items: center; justify-content: center; z-index: 9999; }
  #preview-box, #complete-dialog > div { background: #fff; padding: 15px; border-radius: 10px; text-align: center; max-width: 90%; }
  #preview-canvas { border:1px solid #ccc; background:#eee; width:300px; height:300px; touch-action: none; }
  .preview-btn { margin: 5px; padding: 6px 12px; font-size: 1em; border: none; border-radius: 5px; cursor: pointer; }
  .save-btn { background: #4CAF50; color: white; }
  .cancel-btn { background: #f44336; color: white; }
  #complete-btn { padding: 8px 20px; font-size: 1.1em; border: none; border-radius: 5px; background: #4CAF50; color: #fff; cursor: pointer; }
  #saved-images { margin-top: 15px; display: flex; justify-content: center; }
  #saved-images img { max-width: 150px; border: 1px solid #ccc; border-radius: 4px; }
  #analysis-result { margin-top: 10px; font-size: 0.95em; color: #333; }
  #upload-input { margin-top:10px; }
</style>
</head>
<body>

<div id="camera-container">
  <video id="video" autoplay playsinline></video>
  <canvas id="overlay"></canvas>
  <div id="no-signal">No signal</div>
</div><br>

<button id="control-btn" onclick="toggleCamera()">カメラ開始</button>
<button onclick="saveImage()">カメラ画像保存</button>
<br>
<input type="file" id="upload-input" accept="image/*">

<div id="af-status">AF状態: 未確認</div>

<!-- 撮影／アップロード画像プレビュー -->
<div id="preview-dialog">
  <div id="preview-box">
    <canvas id="preview-canvas"></canvas>
    <div>
      <button class="preview-btn save-btn" onclick="confirmSave()">保存する</button>
      <button class="preview-btn cancel-btn" onclick="closePreview()">キャンセル</button>
    </div>
  </div>
</div>

<!-- 保存完了ダイアログ -->
<div id="complete-dialog">
  <div>
    <p>画像の保存が完了しました。</p>
    <button id="complete-btn">完了</button>
  </div>
</div>

<h3>最新画像</h3>
<div id="saved-images"></div>

<h3>解析結果</h3>
<div id="analysis-result"></div>

<script>
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const noSignal = document.getElementById('no-signal');
const afStatus = document.getElementById('af-status');
const controlBtn = document.getElementById('control-btn');
const ctx = overlay.getContext('2d');

const previewDialog = document.getElementById('preview-dialog');
const previewCanvas = document.getElementById('preview-canvas');
const previewCtx = previewCanvas.getContext('2d');

const savedImages = document.getElementById('saved-images');
const analysisResult = document.getElementById('analysis-result');
const uploadInput = document.getElementById('upload-input');

let isPaused=false, isStarted=false, savedStream=null, currentImageData=null;

// トリミング操作用
let isDragging=false, startX=0, startY=0, endX=0, endY=0;
let originalImage = new Image();

// --- 端末ID ---
function getDeviceId() {
  let id = localStorage.getItem("device_id");
  if (!id) {
    id = "device_" + Math.random().toString(36).slice(2);
    localStorage.setItem("device_id", id);
  }
  return id;
}

// --- カメラ操作 ---
function resizeOverlay() {
  overlay.width = overlay.offsetWidth;
  overlay.height = overlay.offsetHeight;
}
function drawCenterCircle() {
  ctx.clearRect(0,0,overlay.width,overlay.height);
  const cx=overlay.width/2, cy=overlay.height/2, r=Math.min(overlay.width,overlay.height)/4;
  ctx.beginPath();
  ctx.arc(cx, cy, r,0,Math.PI*2);
  ctx.lineWidth=3; ctx.strokeStyle="black"; ctx.stroke();
}
function pauseCamera(){ if(video.srcObject&&!isPaused){ video.pause(); isPaused=true; afStatus.textContent="AF状態: 一時停止中"; controlBtn.textContent="再開"; } }
function resumeCamera(){ if(savedStream&&isPaused){ video.play(); isPaused=false; afStatus.textContent="AF状態: 再開中"; controlBtn.textContent="静止"; } }
async function startCamera(){
  try{
    if(location.protocol!=='https:'&&location.hostname!=='localhost'){ alert('カメラはHTTPS接続またはlocalhostでのみ使用可能'); return; }
    const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const constraints={video:isMobile?{facingMode:{ideal:"environment"}}:{width:{ideal:1280},height:{ideal:720}},audio:false};
    const stream=await navigator.mediaDevices.getUserMedia(constraints);
    savedStream=stream; video.srcObject=stream; video.play(); isPaused=false; isStarted=true;
    noSignal.style.display="none"; controlBtn.textContent="静止";
    resizeOverlay(); drawCenterCircle();
  }catch(err){ noSignal.style.display="flex"; video.srcObject=null; afStatus.textContent="AF状態: 起動失敗"; alert('カメラ起動失敗: '+err.message); }
}
function toggleCamera(){ if(!isStarted) startCamera(); else if(!isPaused) pauseCamera(); else resumeCamera(); }
function saveImage(){
  if(!isStarted){ alert("カメラを開始してください"); return; }
  const tempCanvas=document.createElement("canvas");
  tempCanvas.width=video.videoWidth; tempCanvas.height=video.videoHeight;
  tempCanvas.getContext("2d").drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
  loadPreview(tempCanvas.toDataURL("image/png"));
}

// --- アップロード処理 ---
uploadInput.onchange = e => {
  if(!e.target.files[0]) return;
  const reader=new FileReader();
  reader.onload=ev=> loadPreview(ev.target.result);
  reader.readAsDataURL(e.target.files[0]);
};

// --- プレビューとトリミング ---
function loadPreview(dataURL){
  originalImage.src=dataURL;
  originalImage.onload=()=>{
    previewCtx.clearRect(0,0,previewCanvas.width,previewCanvas.height);
    previewCtx.drawImage(originalImage,0,0,previewCanvas.width,previewCanvas.height);
    previewDialog.style.display="flex";
    currentImageData=dataURL;
  };
}

// --- マウス操作 ---
previewCanvas.onmousedown=e=>{isDragging=true; startX=e.offsetX; startY=e.offsetY;};
previewCanvas.onmousemove=e=>{ if(!isDragging) return; endX=e.offsetX; endY=e.offsetY; drawRect(); };
previewCanvas.onmouseup=e=>{ isDragging=false; };

// --- タッチ操作 ---
previewCanvas.ontouchstart=e=>{
  e.preventDefault();
  if(e.touches.length!==1) return;
  const rect=previewCanvas.getBoundingClientRect();
  startX=e.touches[0].clientX-rect.left;
  startY=e.touches[0].clientY-rect.top;
  isDragging=true;
};
previewCanvas.ontouchmove=e=>{
  e.preventDefault();
  if(!isDragging||e.touches.length!==1) return;
  const rect=previewCanvas.getBoundingClientRect();
  endX=e.touches[0].clientX-rect.left;
  endY=e.touches[0].clientY-rect.top;
  drawRect();
};
previewCanvas.ontouchend=e=>{isDragging=false;};

// --- 矩形描画 ---
function drawRect(){
  previewCtx.clearRect(0,0,previewCanvas.width,previewCanvas.height);
  previewCtx.drawImage(originalImage,0,0,previewCanvas.width,previewCanvas.height);
  previewCtx.strokeStyle="red"; previewCtx.lineWidth=2;
  previewCtx.strokeRect(startX,startY,endX-startX,endY-startY);
}

// --- プレビュー閉じる ---
function closePreview(){ previewDialog.style.display="none"; currentImageData=null; }

// --- 送信 ---
function confirmSave(){
  if(!currentImageData){ alert("保存画像がありません"); return; }

  // トリミング範囲を反映
  const cropCanvas=document.createElement("canvas");
  cropCanvas.width=Math.abs(endX-startX)||previewCanvas.width;
  cropCanvas.height=Math.abs(endY-startY)||previewCanvas.height;
  cropCanvas.getContext("2d").drawImage(previewCanvas,
    Math.min(startX,endX), Math.min(startY,endY), cropCanvas.width, cropCanvas.height,
    0,0,cropCanvas.width,cropCanvas.height
  );
  const sendData=cropCanvas.toDataURL("image/png");

  const deviceId=getDeviceId();
  fetch("https://866797d83d83.ngrok-free.app/upload",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({image:sendData, device_id:deviceId})
  })
  .then(async res=>{
    if(!res.ok){ const errData=await res.json().catch(()=>({})); throw new Error(`HTTP ${res.status}: ${errData.message||"不明なエラー"}`);}
    return res.json();
  })
  .then(data=>{
    if(data.status==="ok"){
      previewDialog.style.display="none";
      const completeDialog=document.getElementById("complete-dialog");
      completeDialog.style.display="flex";
      const completeBtn=document.getElementById("complete-btn");
      completeBtn.onclick=null;
      completeBtn.onclick=()=>{
        completeDialog.style.display="none";
        // 最新画像表示
        savedImages.innerHTML="";
        const img=document.createElement("img"); img.src=sendData; savedImages.appendChild(img);
        // 解析結果表示
        analysisResult.innerHTML=`
          平均RGB: ${data.pink_avg.avg_rgb}<br>
          HEX: ${data.pink_avg.hex}<br>
          濃淡スコア: ${data.pink_avg.shade_score} ( ${data.pink_avg.shade_level} )<br>
          平均S: ${data.pink_avg.avg_S.toFixed(1)}, 平均V: ${data.pink_avg.avg_V.toFixed(1)}
        `;
        currentImageData=null;
      };
    }else throw new Error(data.message||"サーバーエラー");
  })
  .catch(err=>{ console.error(err); alert("送信失敗: "+err.message); });
}

window.addEventListener("resize",()=>{ if(isStarted){ resizeOverlay(); drawCenterCircle(); } });
</script>

</body>
</html>
