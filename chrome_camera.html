<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>カメラ＋アップロード＋円形トリミング＋保存送信</title>
<style>
  body { text-align: center; margin: 0; background: #fff; font-family: sans-serif; }
  #camera-container { position: relative; display: inline-block; }
  video { width: 90vw; max-width: 400px; border-radius: 12px; }
  canvas { display: none; }
  #controls button { margin: 5px; padding: 10px; border-radius: 8px; }
  #latest-result { margin-top: 15px; }
  #latest-image { max-width: 200px; border-radius: 50%; }
  #preview-dialog, #done-dialog {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center;
  }
  .dialog-content {
    background: #fff; padding: 20px; border-radius: 12px; text-align: center; position: relative;
  }
  #crop-canvas { border: 2px dashed #333; cursor: move; }
</style>
</head>
<body>
  <h2>カメラ撮影＋アップロード＋円形トリミング</h2>
  <div id="camera-container">
    <video id="camera" autoplay playsinline></video>
  </div>
  <div id="controls">
    <button id="start-btn">開始</button>
    <button id="stop-btn">静止</button>
    <button id="resume-btn">再開</button>
    <button id="capture-btn">撮影</button>
    <input type="file" id="upload-input" accept="image/*">
  </div>

  <div id="latest-result">
    <h3>最新画像</h3>
    <img id="latest-image" src="" alt="最新画像">
    <p id="latest-analysis">解析結果: なし</p>
  </div>

  <!-- トリミング用ダイアログ -->
  <div id="preview-dialog">
    <div class="dialog-content">
      <h3>画像をトリミング</h3>
      <canvas id="crop-canvas"></canvas><br>
      <button id="save-btn">保存</button>
      <button id="cancel-btn">キャンセル</button>
    </div>
  </div>

  <!-- 完了ダイアログ -->
  <div id="done-dialog">
    <div class="dialog-content">
      <h3>保存完了</h3>
      <button id="close-done-btn">完了</button>
    </div>
  </div>

<script>
const video = document.getElementById("camera");
const cropCanvas = document.getElementById("crop-canvas");
const ctx = cropCanvas.getContext("2d");

let stream = null;
let cropX = 50, cropY = 50, cropSize = 200;
let dragging = false, offsetX = 0, offsetY = 0;
let previewImage = new Image();

// ✅ デバイスID生成
function getDeviceId() {
  let id = localStorage.getItem("device_id");
  if (!id) {
    id = "dev-" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("device_id", id);
  }
  return id;
}
const deviceId = getDeviceId();

// ✅ カメラ開始
document.getElementById("start-btn").onclick = async () => {
  if (!location.protocol.startsWith("https") && location.hostname !== "localhost") {
    alert("HTTPSでアクセスしてください。");
    return;
  }
  stream = await navigator.mediaDevices.getUserMedia({ video: true });
  video.srcObject = stream;
};

// ✅ 停止
document.getElementById("stop-btn").onclick = () => { if (stream) stream.getTracks().forEach(t => t.stop()); };

// ✅ 再開
document.getElementById("resume-btn").onclick = async () => {
  if (!stream) {
    stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
  }
};

// ✅ 撮影
document.getElementById("capture-btn").onclick = () => {
  const tmp = document.createElement("canvas");
  tmp.width = video.videoWidth;
  tmp.height = video.videoHeight;
  tmp.getContext("2d").drawImage(video, 0, 0);
  showPreview(tmp.toDataURL("image/png"));
};

// ✅ ファイルアップロード
document.getElementById("upload-input").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => showPreview(ev.target.result);
  reader.readAsDataURL(file);
};

// ✅ プレビュー表示
function showPreview(dataUrl) {
  previewImage.onload = () => {
    cropCanvas.width = previewImage.width;
    cropCanvas.height = previewImage.height;
    cropX = previewImage.width/2 - 100;
    cropY = previewImage.height/2 - 100;
    cropSize = 200;
    redrawCrop();
    document.getElementById("preview-dialog").style.display = "flex";
  };
  previewImage.src = dataUrl;
}

// ✅ トリミング枠描画（円形＋透明マスク）
function redrawCrop() {
  ctx.clearRect(0,0,cropCanvas.width,cropCanvas.height);
  ctx.drawImage(previewImage, 0, 0);
  ctx.save();
  ctx.beginPath();
  ctx.arc(cropX+cropSize/2, cropY+cropSize/2, cropSize/2, 0, Math.PI*2);
  ctx.clip();
  ctx.drawImage(previewImage, 0, 0);
  ctx.restore();

  // 枠線
  ctx.strokeStyle = "red";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.arc(cropX+cropSize/2, cropY+cropSize/2, cropSize/2, 0, Math.PI*2);
  ctx.stroke();
}

// ✅ ドラッグ操作
cropCanvas.onmousedown = e => { dragging = true; offsetX = e.offsetX-cropX; offsetY = e.offsetY-cropY; };
cropCanvas.onmouseup = () => dragging = false;
cropCanvas.onmousemove = e => {
  if (dragging) { cropX = e.offsetX-offsetX; cropY = e.offsetY-offsetY; redrawCrop(); }
};

// ✅ タッチ操作
cropCanvas.ontouchstart = e => { dragging = true; offsetX = e.touches[0].clientX-cropX; offsetY = e.touches[0].clientY-cropY; };
cropCanvas.ontouchend = () => dragging = false;
cropCanvas.ontouchmove = e => {
  if (dragging) { cropX = e.touches[0].clientX-offsetX; cropY = e.touches[0].clientY-offsetY; redrawCrop(); }
};

// ✅ 保存処理（円形トリミング＋透明背景）
document.getElementById("save-btn").onclick = () => {
  const finalCanvas = document.createElement("canvas");
  finalCanvas.width = cropSize;
  finalCanvas.height = cropSize;
  const fctx = finalCanvas.getContext("2d");

  // 透明背景円
  fctx.save();
  fctx.beginPath();
  fctx.arc(cropSize/2, cropSize/2, cropSize/2, 0, Math.PI*2);
  fctx.clip();
  fctx.drawImage(previewImage, cropX, cropY, cropSize, cropSize, 0, 0, cropSize, cropSize);
  fctx.restore();

  const finalDataUrl = finalCanvas.toDataURL("image/png");

  // サーバー送信
  fetch("http://2cadc5a37ebd.ngrok-free.app/upload", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ image: finalDataUrl, device_id: deviceId })
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("latest-image").src = finalDataUrl;
    document.getElementById("latest-analysis").textContent = "解析結果: " + (data.analysis || "不明");
    document.getElementById("preview-dialog").style.display = "none";
    document.getElementById("done-dialog").style.display = "flex";
  });
};

// ✅ キャンセル
document.getElementById("cancel-btn").onclick = () => {
  document.getElementById("preview-dialog").style.display = "none";
};

// ✅ 完了ボタン
document.getElementById("close-done-btn").onclick = () => {
  document.getElementById("done-dialog").style.display = "none";
};
</script>
</body>
</html>
