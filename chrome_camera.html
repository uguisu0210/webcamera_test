<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>固定円トリミング＋円内切り取り＋ズーム＋プレビュー＋ピンク解析</title>
<style>
body { text-align: center; margin: 0; background: #fff; font-family: sans-serif; }
#camera-container { position: relative; display: inline-block; width: 100vw; max-width: 100%; aspect-ratio: 16/9; background: black; }
video, canvas, #no-signal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
video { object-fit: cover; }
#overlay { pointer-events: none; }
#no-signal { display: none; align-items: center; justify-content: center; background: rgba(255,255,255,0.7); color: black; font-size: 1.2em; }
button { margin-top: 10px; padding: 6px 12px; font-size: 1em; border-radius: 5px; border: none; cursor: pointer; }
#af-status { margin-top: 8px; font-size: 0.9em; color: #555; }

#preview-dialog, #complete-dialog {
  display: none;
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  background: rgba(0,0,0,0.5);
}
#preview-box, #complete-dialog > div {
  background: #fff;
  padding: 15px;
  border-radius: 10px;
  text-align: center;
  max-width: 90%;
  margin: 0 auto;
  display: inline-block;
}
#preview-canvas {
  border:1px solid #ccc;
  background:#eee;
  width: 90vw;        /* 画面幅に応じて自動調整 */
  max-width: 400px;   /* 最大サイズを指定 */
  height: auto;
  touch-action: none;
  cursor: grab;
  display: block;
  margin: 0 auto;
}
.preview-btn { margin: 5px; padding: 6px 12px; font-size: 1em; border: none; border-radius: 5px; cursor: pointer; }
.save-btn { background: #4CAF50; color: white; }
.cancel-btn { background: #f44336; color: white; }
#complete-btn { padding: 8px 20px; font-size: 1.1em; border: none; border-radius: 5px; background: #4CAF50; color: #fff; cursor: pointer; }
#saved-images { margin-top: 15px; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
#saved-images img { max-width: 120px; border: 1px solid #ccc; border-radius: 4px; }
#analysis-result { margin-top: 10px; font-size: 0.95em; color: #333; }
#upload-input { margin-top:10px; }
</style>
</head>
<body>

<div id="camera-container">
  <video id="video" autoplay playsinline></video>
  <canvas id="overlay"></canvas>
  <div id="no-signal">No signal</div>
</div>
<br>
<button id="control-btn" onclick="toggleCamera()">カメラ開始</button>
<button onclick="captureImage()">画像保存</button>
<br>
<p>↓ 写真をアップロードはこちら ↓</p>
<input type="file" id="upload-input" accept="image/*">

<div id="preview-dialog">
  <div id="preview-box">
    <canvas id="preview-canvas"></canvas>
    <div>
      <button class="preview-btn save-btn" onclick="confirmSave()">保存する</button>
      <button class="preview-btn cancel-btn" onclick="closePreview()">キャンセル</button>
    </div>
  </div>
</div>

<div id="complete-dialog">
  <div>
    <p>画像の保存が完了しました。</p>
    <button id="complete-btn">完了</button>
  </div>
</div>

<h3>最新画像</h3>
<div id="saved-images"></div>

<h3>解析結果</h3>
<div id="analysis-result"></div>

<script>
// --- カメラ制御 & 画像キャプチャ ---
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const noSignal = document.getElementById('no-signal');
const controlBtn = document.getElementById('control-btn');

const previewDialog = document.getElementById('preview-dialog');
const previewCanvas = document.getElementById('preview-canvas');
const previewCtx = previewCanvas.getContext('2d');

const savedImages = document.getElementById('saved-images');
const analysisResult = document.getElementById('analysis-result');
const uploadInput = document.getElementById('upload-input');

let isPaused=false, isStarted=false, savedStream=null, currentImageData=null;
let originalImage = new Image();
let imgX=0, imgY=0, startX=0, startY=0, isDragging=false;
let scale=1;
let circleX=0, circleY=0, circleR=0;

// --- デバイスID ---
function getDeviceId() {
  let id = localStorage.getItem("device_id");
  if(!id){ id = "device_"+Math.random().toString(36).slice(2); localStorage.setItem("device_id", id);}
  return id;
}

// --- カメラ ---
async function startCamera(){
  try {
    if(location.protocol!=='https:' && location.hostname!=='localhost'){
      alert('カメラはHTTPS接続またはlocalhostでのみ使用可能'); 
      return;
    }
    const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const constraints = { video: isMobile?{facingMode:{ideal:"environment"}}:{width:{ideal:1280},height:{ideal:720}}, audio:false };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    savedStream = stream;
    video.srcObject = stream;
    video.play();
    isPaused = false;
    isStarted = true;
    noSignal.style.display = "none";
    controlBtn.textContent = "静止";
  } catch(err){
    noSignal.style.display="flex";
    video.srcObject = null;
    alert('カメラ起動失敗: '+err.message);
  }
}

function toggleCamera(){
  if(!isStarted){
    startCamera();
  } else if(!isPaused){
    video.pause();
    isPaused = true;
    controlBtn.textContent = "再開";
  } else {
    video.play();
    isPaused = false;
    controlBtn.textContent = "静止";
  }
}

// --- 画像キャプチャ ---
function captureImage(){
  if(!isStarted){ alert("カメラを開始してください"); return; }
  const tempCanvas=document.createElement("canvas");
  tempCanvas.width=video.videoWidth; tempCanvas.height=video.videoHeight;
  tempCanvas.getContext("2d").drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
  loadPreview(tempCanvas.toDataURL("image/png"));
}

// --- アップロード ---
uploadInput.onchange = e => {
  if(!e.target.files[0]) return;
  const reader=new FileReader();
  reader.onload=ev=>loadPreview(ev.target.result);
  reader.readAsDataURL(e.target.files[0]);
};

// --- プレビュー ---
function resizePreviewCanvas(){
  const rect = previewCanvas.getBoundingClientRect();
  previewCanvas.width = rect.width;
  previewCanvas.height = rect.width; // 正方形
  circleX = previewCanvas.width/2;
  circleY = previewCanvas.height/2;
  circleR = previewCanvas.width/2 - 5;
  drawPreview();
}

function loadPreview(dataURL){
  originalImage.src=dataURL;
  originalImage.onload=()=>{
    scale=1; imgX=0; imgY=0;
    previewDialog.style.display="flex";
    currentImageData=dataURL;
    resizePreviewCanvas();
  };
}

function drawPreview(){
  if(previewCanvas.width===0) resizePreviewCanvas();
  const left=circleX-circleR, top=circleY-circleR, right=circleX+circleR, bottom=circleY+circleR;
  const scaledW=previewCanvas.width*scale, scaledH=previewCanvas.height*scale;
  if(imgX>left) imgX=left; if(imgY>top) imgY=top;
  if(imgX+scaledW<right) imgX=right-scaledW; if(imgY+scaledH<bottom) imgY=bottom-scaledH;

  previewCtx.clearRect(0,0,previewCanvas.width,previewCanvas.height);
  previewCtx.fillStyle='rgba(0,0,0,0.5)'; previewCtx.fillRect(0,0,previewCanvas.width,previewCanvas.height);
  previewCtx.save();
  previewCtx.beginPath(); previewCtx.arc(circleX,circleY,circleR,0,Math.PI*2); previewCtx.closePath(); previewCtx.clip();
  previewCtx.drawImage(originalImage,imgX,imgY,previewCanvas.width*scale,previewCanvas.height*scale);
  previewCtx.restore();
  previewCtx.strokeStyle="red";
  previewCtx.lineWidth=2;
  previewCtx.beginPath();
  previewCtx.arc(circleX,circleY,circleR,0,Math.PI*2);
  previewCtx.stroke();
}

// --- ドラッグ & ズーム ---
previewCanvas.onmousedown=e=>{ isDragging=true; startX=e.clientX; startY=e.clientY; };
previewCanvas.onmousemove=e=>{ if(!isDragging) return; imgX+=e.clientX-startX; imgY+=e.clientY-startY; startX=e.clientX; startY=e.clientY; drawPreview(); };
previewCanvas.onmouseup=previewCanvas.onmouseleave=e=>{ isDragging=false; };
previewCanvas.onwheel=e=>{ e.preventDefault(); scale*=e.deltaY<0?1.1:0.9; drawPreview(); };

previewCanvas.ontouchstart=e=>{
  if(e.touches.length===1){ isDragging=true; startX=e.touches[0].clientX; startY=e.touches[0].clientY; }
};
previewCanvas.ontouchmove=e=>{
  if(e.touches.length===1 && isDragging){
    imgX+=e.touches[0].clientX-startX; imgY+=e.touches[0].clientY-startY;
    startX=e.touches[0].clientX; startY=e.touches[0].clientY;
    drawPreview();
  }
};
previewCanvas.ontouchend=e=>{ if(e.touches.length===0) isDragging=false; };

// --- 保存 ---
function closePreview(){ previewDialog.style.display="none"; currentImageData=null; }
function confirmSave(){
  if(!currentImageData){ alert("保存画像がありません"); return; }
  const cropCanvas = document.createElement("canvas");
  cropCanvas.width = previewCanvas.width;
  cropCanvas.height = previewCanvas.height;
  const ctx2 = cropCanvas.getContext("2d");
  ctx2.clearRect(0,0,cropCanvas.width,cropCanvas.height);
  ctx2.beginPath();
  ctx2.arc(circleX, circleY, circleR, 0, Math.PI*2);
  ctx2.closePath();
  ctx2.clip();
  ctx2.drawImage(originalImage, imgX, imgY, previewCanvas.width*scale, previewCanvas.height*scale);
  const sendData = cropCanvas.toDataURL("image/png");
  const deviceId = getDeviceId();

  // サーバー送信
  fetch("https://df1b78b2faab.ngrok-free.app/upload",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({image:sendData, device_id:deviceId})
  })
  .then(async res=>{
    if(!res.ok){ const errData = await res.json().catch(()=>({})); throw new Error(`HTTP ${res.status}: ${errData.message||"不明なエラー"}`); }
    return res.json();
  })
  .then(data=>{
    if(data.status==="ok"){
      previewDialog.style.display="none";
      const completeDialog=document.getElementById("complete-dialog");
      completeDialog.style.display="flex";
      document.getElementById("complete-btn").onclick=()=>{
        completeDialog.style.display="none";
        savedImages.innerHTML = "";
        const img=document.createElement("img"); img.src=sendData; savedImages.appendChild(img);
        const score = data.pink_avg.shade_score;
        const message = score <= 60 ? "少ない" : "OK";
        analysisResult.innerHTML = `濃淡スコア: ${score} → ${message}`;
        currentImageData=null;
      };
    } else throw new Error(data.message||"サーバーエラー");
  }).catch(err=>{ console.error(err); alert("送信失敗: "+err.message); });
}

window.addEventListener("resize",()=>{ if(previewDialog.style.display==="flex") resizePreviewCanvas(); });
</script>

</body>
</html>
