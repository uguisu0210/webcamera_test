<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>円トリミング＋ドラッグ・ズーム＋サーバー送信</title>
<style>
body { text-align: center; margin: 0; background: #fff; font-family: sans-serif; }
#camera-container { position: relative; display: inline-block; width: 100vw; max-width: 100%; aspect-ratio: 16/9; background: black; }
video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
video { object-fit: cover; }
#overlay { pointer-events: none; }
button { margin: 5px; padding: 6px 12px; font-size: 1em; border-radius: 5px; cursor: pointer; }
#preview-dialog, #complete-dialog { display: none; position: fixed; top:0; left:0; width:100%; height:100%; align-items:center; justify-content:center; background: rgba(0,0,0,0.5); z-index:9999; }
#preview-box, #complete-dialog > div { background:#fff; padding:15px; border-radius:10px; text-align:center; max-width:90%; }
#preview-canvas { border:1px solid #ccc; background:#eee; width:300px; height:300px; touch-action: none; cursor: grab; }
.preview-btn { margin:5px; padding:6px 12px; font-size:1em; border:none; border-radius:5px; cursor:pointer; }
.save-btn { background:#4CAF50; color:white; }
.cancel-btn { background:#f44336; color:white; }
#saved-images img { max-width:150px; border:1px solid #ccc; border-radius:4px; margin-top:10px; }
</style>
</head>
<body>

<div id="camera-container">
  <video id="video" autoplay playsinline></video>
  <canvas id="overlay"></canvas>
</div>
<br>
<button onclick="captureImage()">カメラ画像取得</button>
<input type="file" id="upload-input" accept="image/*"><br>

<div id="preview-dialog">
  <div id="preview-box">
    <canvas id="preview-canvas" width="300" height="300"></canvas><br>
    <button class="preview-btn save-btn" onclick="confirmSave()">保存する</button>
    <button class="preview-btn cancel-btn" onclick="closePreview()">キャンセル</button>
  </div>
</div>

<div id="complete-dialog">
  <div>
    <p>画像の保存が完了しました。</p>
    <button id="complete-btn">完了</button>
  </div>
</div>

<h3>最新画像</h3>
<div id="saved-images"></div>

<script>
const previewDialog = document.getElementById('preview-dialog');
const previewCanvas = document.getElementById('preview-canvas');
const previewCtx = previewCanvas.getContext('2d');
const savedImages = document.getElementById('saved-images');
const uploadInput = document.getElementById('upload-input');

let originalImage = new Image();
let imgX=0, imgY=0, scale=1;
let isDragging=false, startX=0, startY=0;
const circleX=previewCanvas.width/2;
const circleY=previewCanvas.height/2;
const circleR=Math.min(previewCanvas.width, previewCanvas.height)/2-5;
let currentImageData=null;

// --- アップロード ---
uploadInput.onchange = e => {
  if(!e.target.files[0]) return;
  const reader = new FileReader();
  reader.onload = ev => loadPreview(ev.target.result);
  reader.readAsDataURL(e.target.files[0]);
};

// --- カメラ取得（簡易版、既存カメラを表示する場合は拡張可） ---
function captureImage() {
  alert("カメラ取得はここに実装してください（今回はアップロードでテスト可）");
}

// --- プレビュー ---
function loadPreview(dataURL){
  originalImage.src = dataURL;
  originalImage.onload = ()=>{
    scale=1; imgX=0; imgY=0;
    drawPreview();
    previewDialog.style.display="flex";
    currentImageData = dataURL;
  };
}

function drawPreview(){
  previewCtx.clearRect(0,0,previewCanvas.width,previewCanvas.height);
  // 円外暗く
  previewCtx.fillStyle='rgba(0,0,0,0.5)';
  previewCtx.fillRect(0,0,previewCanvas.width,previewCanvas.height);

  // 円内クリップ
  previewCtx.save();
  previewCtx.beginPath();
  previewCtx.arc(circleX,circleY,circleR,0,Math.PI*2);
  previewCtx.closePath();
  previewCtx.clip();

  previewCtx.drawImage(originalImage, imgX, imgY, previewCanvas.width*scale, previewCanvas.height*scale);
  previewCtx.restore();

  // 円枠
  previewCtx.strokeStyle="red"; previewCtx.lineWidth=2;
  previewCtx.beginPath();
  previewCtx.arc(circleX,circleY,circleR,0,Math.PI*2);
  previewCtx.stroke();
}

// --- ドラッグ ---
previewCanvas.onmousedown = e => { isDragging=true; startX=e.clientX; startY=e.clientY; };
previewCanvas.onmousemove = e => {
  if(!isDragging) return;
  imgX += e.clientX - startX;
  imgY += e.clientY - startY;
  startX = e.clientX; startY = e.clientY;
  drawPreview();
};
previewCanvas.onmouseup = previewCanvas.onmouseleave = e => { isDragging=false; };

// --- ズーム ---
function zoomAtCenter(delta){
  const prevScale = scale;
  scale *= delta;
  imgX = circleX - (circleX - imgX)*(scale/prevScale);
  imgY = circleY - (circleY - imgY)*(scale/prevScale);
  drawPreview();
}
previewCanvas.onwheel = e => { e.preventDefault(); zoomAtCenter(e.deltaY<0?1.1:0.9); };

// --- タッチ ---
let lastDist=0;
previewCanvas.ontouchstart = e=>{
  if(e.touches.length===1){ isDragging=true; startX=e.touches[0].clientX; startY=e.touches[0].clientY; }
  else if(e.touches.length===2){ lastDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY); }
};
previewCanvas.ontouchmove = e=>{
  e.preventDefault();
  if(e.touches.length===1 && isDragging){
    imgX += e.touches[0].clientX - startX;
    imgY += e.touches[0].clientY - startY;
    startX = e.touches[0].clientX; startY = e.touches[0].clientY;
    drawPreview();
  } else if(e.touches.length===2){
    let dist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
    zoomAtCenter(dist/lastDist);
    lastDist = dist;
  }
};
previewCanvas.ontouchend = e=>{ if(e.touches.length<2) lastDist=0; if(e.touches.length===0) isDragging=false; };

// --- 閉じる ---
function closePreview(){ previewDialog.style.display="none"; currentImageData=null; }

// --- デバイスID ---
function getDeviceId() {
  let id = localStorage.getItem("device_id");
  if(!id){ id="device_"+Math.random().toString(36).slice(2); localStorage.setItem("device_id",id);}
  return id;
}

// --- 保存・サーバー送信 ---
function confirmSave(){
  if(!currentImageData){ alert("保存画像がありません"); return; }

  const cropCanvas = document.createElement("canvas");
  cropCanvas.width = circleR*2;
  cropCanvas.height = circleR*2;
  const ctx2 = cropCanvas.getContext("2d");

  // 円形クリップ
  ctx2.beginPath();
  ctx2.arc(circleR,circleR,circleR,0,Math.PI*2);
  ctx2.closePath();
  ctx2.clip();

  // 元画像とプレビュー比率
  const scaleX = originalImage.width / previewCanvas.width;
  const scaleY = originalImage.height / previewCanvas.height;

  // プレビューの imgX, imgY, scale を正確に元画像に反映
  const sx = -imgX * scaleX;
  const sy = -imgY * scaleY;
  const sw = previewCanvas.width * scale * scaleX;
  const sh = previewCanvas.height * scale * scaleY;

  ctx2.drawImage(originalImage, sx, sy, sw, sh, 0, 0, circleR*2, circleR*2);

  // サーバー送信
  const sendData = cropCanvas.toDataURL("image/png");
  const deviceId = getDeviceId();

  fetch("https://78596d55379b.ngrok-free.app/upload",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({image:sendData, device_id:deviceId})
  }).then(async res=>{
    if(!res.ok){ const errData = await res.json().catch(()=>({})); throw new Error(`HTTP ${res.status}: ${errData.message||"不明なエラー"}`);}
    return res.json();
  }).then(data=>{
    if(data.status==="ok"){
      previewDialog.style.display="none";
      const completeDialog=document.getElementById("complete-dialog");
      completeDialog.style.display="flex";
      document.getElementById("complete-btn").onclick=()=>{
        completeDialog.style.display="none";
        const img=document.createElement("img");
        img.src=sendData;
        savedImages.innerHTML="";
        savedImages.appendChild(img);
        currentImageData=null;
      };
    } else throw new Error(data.message||"サーバーエラー");
  }).catch(err=>{console.error(err); alert("送信失敗: "+err.message);});
}



</script>
</body>
</html>



