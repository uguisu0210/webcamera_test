<script>
// 端末IDをlocalStorageに保存し取得する関数
function getDeviceId() {
  let id = localStorage.getItem("device_id");
  if (!id) {
    // ランダムID作成
    id = "device_" + Math.random().toString(36).slice(2);
    localStorage.setItem("device_id", id);
  }
  return id;
}

// confirmSave() の fetch 部分を修正して device_id 追加
function confirmSave() {
  if (!currentImageData) {
    alert("保存する画像がありません。先に撮影してください。");
    return;
  }

  const deviceId = getDeviceId();

  console.log("[DEBUG] 画像送信開始 device_id=" + deviceId);

  fetch("https://1a3b5c12c094.ngrok-free.app/upload", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ 
      image: currentImageData,
      device_id: deviceId
    })
  })
  .then(async (res) => {
    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      throw new Error(`HTTP ${res.status}: ${errData.message || "不明なエラー"}`);
    }
    return res.json();
  })
  .then(data => {
    if (data.status === "ok") {
      console.log("[INFO] Pythonサーバに保存しました:", data.filename);
      alert(`Pythonサーバに保存しました: ${data.filename}`);
    } else {
      throw new Error(data.message || "サーバーがエラーを返しました");
    }
  })
  .catch(err => {
    console.error("[ERROR] 送信失敗:", err);
    alert(`サーバ送信エラー: ${err.message}`);
  });

  // HTML内にも保存
  const img = document.createElement("img");
  img.src = currentImageData;
  savedImages.appendChild(img);

  closePreview();
}
</script>

